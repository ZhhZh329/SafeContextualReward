<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>P2G WFST Examples (Phones → Graphemes)</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  :root{
    --bg:#0b0f14; --fg:#e8eef6; --muted:#a9b4c0;
    --node:#1f2940; --edge:#7aa2f7; --bad:#f7768e; --ok:#9ece6a; --mid:#e0af68;
    --panel:#111826; --panel-border:#1e293b;
  }
  html,body{background:var(--bg);color:var(--fg);font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;}
  h1,h2{margin:16px 0 8px}
  .wrap{max-width:1080px;margin:24px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid var(--panel-border);border-radius:12px;padding:16px;margin:16px 0;box-shadow:0 4px 20px rgba(0,0,0,.25)}
  .legend{display:flex;gap:16px;flex-wrap:wrap;margin:8px 0 0 0;color:var(--muted)}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--panel-border);background:#0d1522}
  svg{width:100%;height:auto;background:#0a1220;border-radius:10px}
  .node{fill:var(--node);stroke:#3b4c6a;stroke-width:1}
  .final{stroke:#7aa2f7;stroke-width:2}
  .label{fill:var(--fg);font:12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .comment{fill:var(--muted);font:12px/1.3 system-ui}
  .edge{stroke:var(--edge);stroke-width:1.6;fill:none;marker-end:url(#arrow)}
  .edge-bad{stroke:var(--bad)}
  .edge-ok{stroke:var(--ok)}
  .edge-mid{stroke:var(--mid)}
  .elabel{fill:#cfe1ff;font:12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .section-title{margin:4px 0 10px;color:#b5c6e0;font-weight:700;letter-spacing:.4px}
  .grid{display:grid;gap:16px}
  @media(min-width:860px){ .grid{grid-template-columns:1fr 1fr} }
  code{background:#0e1526;padding:2px 6px;border-radius:6px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Phones → Graphemes (WFST) — Visual Examples</h1>
  <div class="card">
    <div class="legend">
      <div class="pill">Edge label: <code>input:output / weight</code></div>
      <div class="pill">Lower weight = better (−log&nbsp;prob)</div>
      <div class="pill" style="border-color:#375; color:#cfe">Preferred path: <span style="color:#9ece6a">green edges</span></div>
      <div class="pill" style="border-color:#753; color:#cfe">Alternative: <span style="color:#e0af68">amber edges</span></div>
      <div class="pill" style="border-color:#a55; color:#cfe">Disfavored: <span style="color:#f7768e">red edges</span></div>
    </div>
  </div>

  <!-- Example 1 -->
  <div class="card">
    <h2>Example 1: <code>/ K AE1 T / → "cat"</code></h2>
    <p class="comment">
      P2G（含上下文偏好）给出 <code>K→c</code>（词后为前元音时更优，w=0.1）与 <code>K→k</code>（w=0.3）两条候选；
      <code>AE→a</code>、<code>T→t</code> 权重较小。字符级 LM（未在此图中展开）进一步偏好 “c→a→t” 的 n-gram。
      组合（<em>compose</em>）后最短路径输出 <strong>cat</strong>。
    </p>
    <svg viewBox="0 0 900 260" role="img" aria-label="/K AE1 T/ to cat WFST">
      <defs>
        <marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse">
          <path d="M 0 0 L 10 5 L 0 10 z" fill="#86b1ff"/>
        </marker>
      </defs>
      <!-- States -->
      <g>
        <circle class="node final" cx="80" cy="130" r="20"/>
        <text class="label" x="80" y="135" text-anchor="middle">s0</text>

        <circle class="node" cx="260" cy="70" r="20"/>
        <text class="label" x="260" y="75" text-anchor="middle">s1</text>

        <circle class="node" cx="260" cy="190" r="20"/>
        <text class="label" x="260" y="195" text-anchor="middle">s1'</text>

        <circle class="node" cx="460" cy="130" r="20"/>
        <text class="label" x="460" y="135" text-anchor="middle">s2</text>

        <circle class="node final" cx="660" cy="130" r="20"/>
        <text class="label" x="660" y="135" text-anchor="middle">s3</text>

        <circle class="node final" cx="840" cy="130" r="20"/>
        <text class="label" x="840" y="135" text-anchor="middle">end</text>
      </g>

      <!-- Edges: K→c (good) and K→k (worse) -->
      <path class="edge edge-ok" d="M100,130 C150,130 190,90 240,80"/>
      <text class="elabel" x="200" y="90">K:c / 0.10</text>

      <path class="edge edge-mid" d="M100,130 C150,130 190,170 240,180"/>
      <text class="elabel" x="200" y="175">K:k / 0.30</text>

      <!-- AE→a -->
      <path class="edge" d="M280,70 C330,80 400,90 440,110"/>
      <text class="elabel" x="380" y="95">AE→a / 0.05</text>

      <path class="edge" d="M280,190 C330,180 400,170 440,150"/>
      <text class="elabel" x="380" y="175">AE→a / 0.05</text>

      <!-- T→t -->
      <path class="edge edge-ok" d="M480,130 C520,130 600,130 640,130"/>
      <text class="elabel" x="560" y="120">T→t / 0.05</text>

      <!-- Emit end -->
      <path class="edge" d="M680,130 C720,130 800,130 820,130"/>
      <text class="elabel" x="750" y="120">$:ε / 0.00</text>

      <!-- Output strings (for illustration) -->
      <text class="label" x="260" y="45" text-anchor="middle">emit: c</text>
      <text class="label" x="260" y="215" text-anchor="middle">emit: k</text>
      <text class="label" x="460" y="105" text-anchor="middle">emit: a</text>
      <text class="label" x="660" y="105" text-anchor="middle">emit: t</text>

      <!-- Comment -->
      <text class="comment" x="40" y="28">Phones: ^ K AE1 T $</text>
      <text class="comment" x="40" y="48">Preferred path (green): K→c, AE→a, T→t → "cat"</text>
    </svg>
  </div>

  <!-- Example 2 -->
  <div class="card">
    <h2>Example 2: <code>/ AE1 K SH AH0 N / → "action"</code></h2>
    <p class="comment">
      这里演示一个<strong>跨多音素→多字母</strong>的块映射：<code>{SH AH N} → "tion"</code>（w=0.05），
      与较差替代路径 <code>SH→"sh"</code>, <code>AH→"a"</code>, <code>N→"n"</code>（累计更大权重）。
      上下文 transducer 偏好 <code>K→c</code> 若其后将产生 <code>"tion"</code>。字符 n-gram LM 再次加分 "a c tion"。
    </p>
    <svg viewBox="0 0 980 360" role="img" aria-label="/AE K SH AH N/ to action WFST">
      <defs>
        <marker id="arrow2" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse">
          <path d="M 0 0 L 10 5 L 0 10 z" fill="#86b1ff"/>
        </marker>
      </defs>
      <!-- States -->
      <g>
        <circle class="node final" cx="70" cy="170" r="20"/>
        <text class="label" x="70" y="175" text-anchor="middle">s0</text>

        <circle class="node" cx="220" cy="170" r="20"/>
        <text class="label" x="220" y="175" text-anchor="middle">s1</text>

        <circle class="node" cx="370" cy="170" r="20"/>
        <text class="label" x="370" y="175" text-anchor="middle">s2</text>

        <!-- block branch good -->
        <circle class="node" cx="580" cy="120" r="20"/>
        <text class="label" x="580" y="125" text-anchor="middle">s3</text>

        <circle class="node" cx="760" cy="120" r="20"/>
        <text class="label" x="760" y="125" text-anchor="middle">s4</text>

        <!-- alt branch worse -->
        <circle class="node" cx="580" cy="250" r="20"/>
        <text class="label" x="580" y="255" text-anchor="middle">s3'</text>

        <circle class="node" cx="760" cy="250" r="20"/>
        <text class="label" x="760" y="255" text-anchor="middle">s4'</text>

        <circle class="node final" cx="920" cy="170" r="20"/>
        <text class="label" x="920" y="175" text-anchor="middle">end</text>
      </g>

      <!-- AE→a -->
      <path class="edge" d="M90,170 C130,170 170,170 200,170" marker-end="url(#arrow2)"/>
      <text class="elabel" x="145" y="158">AE→a / 0.10</text>

      <!-- K→c (context prefers if 'tion' follows) -->
      <path class="edge edge-ok" d="M240,170 C280,170 320,170 350,170" marker-end="url(#arrow2)"/>
      <text class="elabel" x="295" y="158">K→c / 0.20 (if 'tion' next)</text>

      <!-- good block: {SH AH N}→tion -->
      <path class="edge edge-ok" d="M390,170 C470,150 500,135 560,125" marker-end="url(#arrow2)"/>
      <text class="elabel" x="490" y="135">{SH AH N}:{t i o n} / 0.05</text>

      <!-- alt: SH→sh, AH→a, N→n (worse) -->
      <path class="edge edge-bad" d="M390,170 C470,190 500,210 560,240" marker-end="url(#arrow2)"/>
      <text class="elabel" x="490" y="230">SH→sh / 0.30</text>

      <path class="edge edge-bad" d="M600,250 C650,250 700,250 740,250" marker-end="url(#arrow2)"/>
      <text class="elabel" x="670" y="238">AH→a / 0.40</text>

      <path class="edge edge-bad" d="M780,250 C820,240 860,220 900,190" marker-end="url(#arrow2)"/>
      <text class="elabel" x="845" y="230">N→n / 0.20</text>

      <!-- end (good path) -->
      <path class="edge" d="M780,120 C830,125 870,140 900,160" marker-end="url(#arrow2)"/>
      <text class="elabel" x="840" y="110">$:ε / 0.00</text>

      <!-- Output hints -->
      <text class="label" x="220" y="145" text-anchor="middle">emit: a</text>
      <text class="label" x="370" y="145" text-anchor="middle">emit: c</text>
      <text class="label" x="580" y="95"  text-anchor="middle">emit: tion</text>
      <text class="label" x="580" y="280" text-anchor="middle">emit: sh</text>
      <text class="label" x="760" y="280" text-anchor="middle">emit: a</text>

      <text class="comment" x="30" y="28">Phones: ^ AE1 K SH AH0 N $</text>
      <text class="comment" x="30" y="48">Best path (green): a c + {SH AH N}→tion  → "action"</text>
      <text class="comment" x="30" y="68">Alt path (red): a k sh a n  (higher total weight, disfavored)</text>
    </svg>
  </div>

  <!-- Optional: tiny character LM sketch -->
  <div class="card">
    <div class="section-title">Character n-gram LM (sketch)</div>
    <div class="grid">
      <div>
        <p class="comment">LM prefers common orthographic bigrams/trigrams (e.g., <code>c→a</code>, <code>a→t</code>, <code>c→t</code> in “cat”; <code>c→t</code>, <code>t→i</code>, <code>i→o</code>, <code>o→n</code> in “ction”). These costs are added via composition, nudging the shortest path toward natural spellings.</p>
      </div>
      <div>
        <svg viewBox="0 0 500 180" role="img" aria-label="Char LM sketch">
          <defs>
            <marker id="arrow3" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse">
              <path d="M 0 0 L 10 5 L 0 10 z" fill="#86b1ff"/>
            </marker>
          </defs>
          <circle class="node" cx="60" cy="90" r="18"/><text class="label" x="60" y="95" text-anchor="middle">c</text>
          <circle class="node" cx="180" cy="90" r="18"/><text class="label" x="180" y="95" text-anchor="middle">a</text>
          <circle class="node" cx="300" cy="90" r="18"/><text class="label" x="300" y="95" text-anchor="middle">t</text>
          <path class="edge edge-ok" d="M78,90 C100,90 140,90 162,90" marker-end="url(#arrow3)"/>
          <text class="elabel" x="120" y="78">c→a / 0.01</text>
          <path class="edge edge-ok" d="M198,90 C220,90 260,90 282,90" marker-end="url(#arrow3)"/>
          <text class="elabel" x="240" y="78">a→t / 0.01</text>

          <!-- a rare alternative -->
          <circle class="node" cx="180" cy="150" r="18"/><text class="label" x="180" y="155" text-anchor="middle">o</text>
          <path class="edge edge-bad" d="M78,90 C110,110 140,130 162,145" marker-end="url(#arrow3)"/>
          <text class="elabel" x="130" y="130">c→o / 0.08</text>
        </svg>
      </div>
    </div>
  </div>

  <div class="card">
    <p class="comment">
      <strong>解释</strong>：上述图把 L（phones→graphemes）、C（上下文偏好）与 G<sub>char</sub>（字符 n-gram LM）用“边权”表达。
      实际系统中我们通过 FST <em>compose</em> 把这些部件串接，然后用 <em>N-shortest paths</em> 取得前 N 个候选。
      由于 <em>G<sub>char</sub></em> 会对 <code>qu</code>、<code>tion</code>、<code>ck</code> 等常见块给低损失，配合 L/C 的块映射（如 <code>{SH AH N}→tion</code>），最终得到<strong>正字法自然</strong>的输出。
    </p>
  </div>

</div>
</body>
</html>
